{% extends "base.html" %}
{# Copyright The IETF Trust 2015, All Rights Reserved #}
{% load origin %}
{% load agenda_custom_tags %}

{% block title %}IETF {{ meeting.number }} Meeting Agenda: Timeslot/Room Availability{% endblock %}

{% block morecss %}
  .tstable { width: 100%;}
  .tstable th { white-space: nowrap;}
  .tstable td { white-space: nowrap;}
  .capacity { font-size:80%; font-weight: normal;}
{% endblock %}

{% block content %}
  {% origin %}

  <p class="pull-right">
    <a href="{% url "ietf.meeting.views.create_timeslot" num=meeting.number %}">New timeslot</a>
  </p>
  <div class="timeslot-edit">
  <table id="timeslot-table" class="tstable table table-striped table-compact table-bordered">
    <thead>
    <tr>
      <th></th>
      {% for day in time_slices %}
        <th colspan="{{date_slices|colWidth:day}}">
          {{day|date:'D'}}&nbsp;({{day}})
          <span class="fa fa-trash delete-button"
                title="Delete all on this day"
                data-delete-scope="day"
                data-date-id="{{ day.isoformat }}">
          </span>
        </th>
      {% endfor %}
    </tr>
    <tr>
      <th></th>
      {% for day in time_slices %}
        {% for slot in slot_slices|lookup:day %}
          <th>
            {{slot.time|date:'H:i'}}-{{slot.end_time|date:'H:i'}}
            <span class="fa fa-trash delete-button"
                  data-delete-scope="column"
                  data-date-id="{{ day.isoformat }}"
                  data-col-id="{{ day.isoformat }}T{{slot.time|date:'H:i'}}-{{slot.end_time|date:'H:i'}}"
                  title="Delete all in this column">
            </span>
          </th>
        {% endfor %}
      {% endfor %}
    </tr>
    </thead>

    <tbody>
    {% for room in rooms %}
      <tr>
        <th>{{room.name}}{% if room.capacity %} <span class='capacity'>({{room.capacity}})</span>{% endif %}</th>
        {% for day in time_slices %}
          {% for slice in date_slices|lookup:day %}{% with cell_ts=ts_list.popleft %}
            <td class="tscell {% if cell_ts|length > 1 %}timeslot-collision {% endif %}{% for ts in cell_ts %}tstype_{{ ts.type.slug }} {% endfor %}">
            {% for ts in cell_ts %}
              {% include 'meeting/timeslot_edit_timeslot.html' with ts=ts in_use=ts_with_any_assignments in_official_use=ts_with_official_assignments only %}
            {% endfor %}
          {% endwith %}{% endfor %}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
    </tbody>
  </table>

  {# Modal to confirm timeslot deletion #}
  <div id="delete-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">
            <span aria-hidden="true">&times;</span>
            <span class="sr-only">Close</span>
          </button>
          <h4 class="modal-title">Confirm Delete</h4>
        </div>

        <div class="modal-body">
          <p>The following timeslot will be deleted:</p>
          <dl class="dl-horizontal">
            <dt>Name</dt><dd><span class="ts-name"></span></dd>
            <dt>Date</dt><dd><span class="ts-date"></span></dd>
            <dt>Time</dt><dd><span class="ts-time"></span></dd>
            <dt>Location</dt><dd><span class="ts-location"></span></dd>
          </dl>
          <p class="unofficial-use-warning">
            The official schedule will not be affected, but sessions in
            unofficial schedules currently assigned to this timeslot
            will become unassigned.
          </p>
          <p class="official-use-warning">
            The official schedule will be affected.
            Sessions currently assigned to this timeslot will become unassigned.
          </p>
          <p>Are you sure you want to delete this timeslot?</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" id="confirm-delete-button" class="btn btn-primary">Delete</button>
        </div>
      </div>
    </div>
  </div>
  </div>

{% endblock %}

{% block js %}
  <script type="text/javascript">
  // create a namespace for local JS
  timeslotEdit = (function() {
    let deleteModal;
    let timeslotTableBody = document.querySelector('#timeslot-table tbody');

    function initializeDeleteModal() {
      deleteModal = jQuery('#delete-modal');
      deleteModal.eltsToDelete = null; // PK of TimeSlot that modal 'Delete' button should delete
      deleteModal.elts = {
        unofficialUseWarning: deleteModal.find('.unofficial-use-warning'),
        officialUseWarning: deleteModal.find('.official-use-warning'),
        timeslotNameSpans: deleteModal.find('span.ts-name'),
        timeslotDateSpans: deleteModal.find('span.ts-date'),
        timeslotTimeSpans: deleteModal.find('span.ts-time'),
        timeslotLocSpans: deleteModal.find('span.ts-location')
      };

      document.getElementById('confirm-delete-button').addEventListener(
        'click',
        () => timeslotEdit.handleDeleteButtonClick()
      );

      deleteModal.openModal = function (eltsToDelete) {
        eltsToDelete.forEach(timeslotElt => {
          let unofficialUse = Boolean(timeslotElt.dataset.unofficialUse === 'true'); // is a session assigned in any schedule?
          let officialUse = Boolean(timeslotElt.dataset.officialUse === 'true'); // is a session assigned in the official schedule?
          deleteModal.elts.unofficialUseWarning.hide();
          deleteModal.elts.officialUseWarning.hide();
          deleteModal.elts.timeslotNameSpans.text(timeslotElt.dataset.timeslotName);
          deleteModal.elts.timeslotDateSpans.text(timeslotElt.dataset.timeslotDate);
          deleteModal.elts.timeslotTimeSpans.text(timeslotElt.dataset.timeslotTime);
          deleteModal.elts.timeslotLocSpans.text(timeslotElt.dataset.timeslotLocation);
          if (officialUse) {
            deleteModal.elts.officialUseWarning.show();
          } else if (unofficialUse) {
            deleteModal.elts.unofficialUseWarning.show();
          }
        });

        deleteModal.eltsToDelete  = eltsToDelete;
        deleteModal.modal('show');
      }

      /**
       * Handle deleting a single timeslot
       *
       * clicked arg is the clicked element, which must be a child of the timeslot element
       */
      function deleteSingleTimeSlot(clicked) {
        deleteModal.openModal([clicked.closest('.timeslot')]);
      }

      /**
       * Handle deleting an entire day worth of timeslots
       *
       * clicked arg is the clicked element, which must be a child of the day header element
       */
      function deleteDay(clicked) {
        // Find all timeslots for this day
        let dateId = clicked.dataset.dateId;
        let timeslots = timeslotTableBody.querySelectorAll(
          ':scope .timeslot[data-date-id="' + dateId + '"]' // :scope prevents picking up results outside table body
        );
        if (timeslots.length > 0) {
          deleteModal.openModal(timeslots);
        }
      }

      /**
       * Handle deleting an entire column worth of timeslots
       *
       * clicked arg is the clicked element, which must be a child of the column header element
       */
      function deleteColumn(clicked) {
        let colId = clicked.dataset.colId;
        let timeslots = timeslotTableBody.querySelectorAll(
          ':scope .timeslot[data-col-id="' + colId + '"]' // :scope prevents picking up results outside table body
        );
        if (timeslots.length > 0) {
          deleteModal.openModal(timeslots);
        }
      }

      /**
       * Event handler for clicks on the timeslot table
       *
       * Handles clicks on all the delete buttons to avoid large numbers of event handlers.
       */
      document.getElementById('timeslot-table').addEventListener('click', function(event) {
        let clicked = event.target; // find out what was clicked
        if (clicked.dataset.deleteScope) {
          switch (clicked.dataset.deleteScope) {
            case 'timeslot':
              deleteSingleTimeSlot(clicked)
              break

            case 'column':
              deleteColumn(clicked)
              break

            case 'day':
              deleteDay(clicked)
              break

            default:
              throw new Error('Unexpected deleteScope "' + clicked.dataset.deleteScope + '"')
          }
        }
      });
    }

    // Update timeslot classes when DOM changes
    function tstableObserveCallback(mutationList) {
      mutationList.forEach(mutation => {
        if (mutation.type === 'childList' && mutation.target.classList.contains('tscell')) {
          const tscell = mutation.target;
          // mark collisions
          if (tscell.getElementsByClassName('timeslot').length > 1) {
            tscell.classList.add('timeslot-collision');
          } else {
            tscell.classList.remove('timeslot-collision');
          }

          // remove timeslot type classes for any removed timeslots
          mutation.removedNodes.forEach(node => {
            if (node.classList.contains('timeslot') && node.dataset.timeslotType) {
              tscell.classList.remove('tstype_' + node.dataset.timeslotType);
            }
          });

          // now add timeslot type classes for any remaining timeslots
          Array.from(tscell.getElementsByClassName('timeslot')).forEach(elt => {
            if (elt.dataset.timeslotType) {
              tscell.classList.add('tstype_' + elt.dataset.timeslotType);
            }
          });
        }
      });
    }

    function initializeTsTableObserver() {
      const observer = new MutationObserver(tstableObserveCallback);
      observer.observe(timeslotTableBody, { childList: true, subtree: true });
    }

    window.addEventListener('load', function (event) {
      initializeTsTableObserver();
      initializeDeleteModal();
    });

    function removeTimeslotElement(elt) {
      if (elt.parentNode) {
        elt.parentNode.removeChild(elt);
      }
    }

    function handleDeleteButtonClick() {
      if (!deleteModal || !deleteModal.eltsToDelete) {
        return; // do nothing if not yet initialized
      }

      let timeslotElts = Array.from(deleteModal.eltsToDelete); // make own copy as Array so we have .map()
      ajaxDeleteTimeSlot(timeslotElts.map(elt => elt.dataset.timeslotPk))
      .error(function(jqXHR, textStatus) {
        displayError('Error deleting timeslot: ' + jqXHR.responseText)
      })
      .done(function () {timeslotElts.forEach(tse => tse.parentNode.removeChild(tse))})
      .always(function () {deleteModal.modal('hide')});
    }

    /**
     * Make an AJAX request to delete a TimeSlot
     *
     * @param pkArray array of PKs of timeslots to delete
     * @returns jqXHR object corresponding to jQuery ajax request
     */
    function ajaxDeleteTimeSlot(pkArray) {
      return jQuery.ajax({
        method: 'post',
        timeout: 5 * 1000,
        data: {
          action: 'delete',
          slot_id: pkArray.join(',')
        }
      });
    }

    function displayError(msg) {
      window.alert(msg);
    }

    // export callable methods
    return {
      handleDeleteButtonClick: handleDeleteButtonClick,
    }
  })();
  </script>
{% endblock %}